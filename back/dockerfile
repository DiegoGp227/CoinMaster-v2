# ============================================
# DOCKERFILE PARA BACKEND CON PRISMA
# ============================================

# ============================================
# Etapa 1: Builder
# ============================================
FROM node:20-alpine AS builder

# Instalar OpenSSL (requerido por Prisma)
RUN apk add --no-cache openssl

WORKDIR /app

# Copiar archivos de dependencias
COPY package*.json ./
COPY prisma ./prisma

# Instalar todas las dependencias (incluyendo devDependencies)
RUN npm ci

ENV DATABASE_URL="mysql://dummy:dummy@localhost:3306/dummy"

# Generar cliente de Prisma
RUN npx prisma generate

# Copiar el resto del código fuente
COPY . .

# Compilar TypeScript a JavaScript
RUN npm run build

# ============================================
# Etapa 2: Producción
# ============================================
FROM node:20-alpine AS production

# Instalar OpenSSL (requerido por Prisma)
RUN apk add --no-cache openssl

WORKDIR /app

# Copiar archivos de configuración
COPY package*.json ./
COPY prisma ./prisma

# Instalar SOLO dependencias de producción
RUN npm ci --only=production

# Copiar cliente de Prisma generado desde el builder
COPY --from=builder /app/node_modules/.prisma ./node_modules/.prisma
COPY --from=builder /app/node_modules/@prisma ./node_modules/@prisma

# Copiar código compilado desde el builder
COPY --from=builder /app/dist ./dist

# Crear usuario no-root para seguridad
RUN addgroup -g 1001 -S nodejs && \
    adduser -S nodejs -u 1001

# Cambiar permisos
RUN chown -R nodejs:nodejs /app

# Cambiar a usuario no-root
USER nodejs

# Exponer puerto
EXPOSE 4001

# Variables de entorno por defecto
ENV NODE_ENV=production
ENV PORT=4001

# Health check
HEALTHCHECK --interval=30s --timeout=3s --start-period=40s --retries=3 \
  CMD node -e "require('http').get('http://localhost:4001/ping', (r) => {if (r.statusCode !== 200) throw new Error(r.statusCode)})"

# Script de inicio
CMD ["sh", "-c", "npx prisma migrate deploy && node dist/src/index.js"]